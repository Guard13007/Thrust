<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Thrust</title>
	<style>
		*{margin:0px;padding:0px;}
		canvas{width:100%;height:100%;background:black;}
	</style>
	<script>
		var canvas,context,ship;
		var io={
			keysHeld:[],
			keyDown:function(e){
				var code=e.keyCode? e.keyCode : e.charCode;
				io.keysHeld[code]=true;
				//console.log(code);
			},
			keyUp:function(e){
				var code=e.keyCode? e.keyCode : e.charCode;
				io.keysHeld[code]=false;
			}
		};
		var speeds={
			exhaustMinVelocity:16,//9,
			exhaustMaxVelocity:20//12
		};



		var vector=function(x,y){
			x? this.x=x : this.x=0;
			y? this.y=y : this.y=0;
		};



		var Ship=function(x,y){
			this.color="red";
			this.x=x;
			this.y=y;
			this.width=40;
			this.height=40;
			this.v=new vector();
			this.exhaust=[];
		};
		Ship.prototype.draw=function(){
			context.fillStyle=this.color;
			context.fillRect(this.x-this.width/2,this.y-this.height/2,this.width,this.height);
		};



		var Exhaust=function(x,y,Vx,Vy){
			this.x=x;
			this.y=y;
			this.width=4;
			this.height=8;
			this.color=255;
			this.v=new vector(Vx,Vy);
		};
		Exhaust.prototype.draw=function(){
			context.fillStyle="rgb("+this.color+","+this.color+","+this.color+")";
			context.fillRect(this.x-this.width/2,this.y-this.height/2,this.width,this.height);
		};



		function forEach(arr,func){
			for (var i=0;i<arr.length;i++)
				func(arr[i]);
		}
		function random(min,max){
			return Math.random()*(max-min)+min;
		}
		function clear(){
			context.clearRect(0,0,window.innerWidth,window.innerHeight);
		}
		function loop(){
			//update ship pos
			ship.x+=ship.v.x;
			ship.y+=ship.v.y;
			//check ship border collisions
			if(ship.y>window.innerHeight-ship.height/2){
				ship.y=window.innerHeight-ship.height/2;
				ship.v.y=0;
				ship.v.x*=0.8;
			}else if(ship.y<0+ship.height/2){
				ship.y=0+ship.height/2;
				ship.v.y=0;
				ship.v.x*=0.8;
			}
			if(ship.x>window.innerWidth-ship.width/2){
				ship.x=window.innerWidth-ship.width/2;
				ship.v.x=0;
				ship.v.y*=0.8;
			}else if(ship.x<0+ship.width/2){
				ship.x=0+ship.width/2;
				ship.v.x=0;
				ship.v.y*=0.8;
			}
			//update exhaust pos
			forEach(ship.exhaust,function(b){
				b.x+=b.v.x;
				b.y+=b.v.y;
				//check exhaust border collision
				if(b.y>window.innerHeight-b.height/2){
					b.y=window.innerHeight-b.height/2;
					b.v.y=-b.v.y;
					b.v.y*=0.9;
				}else if(b.y<0+b.height/2){
					b.y=0+b.height/2;
					b.v.y=-b.v.y;
					b.v.y*=0.9;
				}
				if(b.x>window.innerWidth-b.width/2){
					b.x=window.innerWidth-b.width/2;
					b.v.x=-b.v.x;
					b.v.x*=0.9;
				}else if(b.x<0+b.width/2){
					b.x=0+b.width/2;
					b.v.x=-b.v.x;
					b.v.x*=0.9;
				}
				//SHIP COLLIDE
				if( b.x-b.width/2   < ship.x+ship.width/2 &&
					b.x+b.width/2  > ship.x-ship.width/2 &&
					b.y-b.height/2 < ship.y+ship.height/2 &&
					b.y+b.height/2 > ship.y-ship.width/2
				){
					//collision!
					//ship.exhaust.splice(ship.exhaust.indexOf(b),1);
					b.v.x+=ship.v.x;
					b.v.y+=ship.v.y;
				}
			});
			//update ship velocity
			ship.v.y+=0.5;
			ship.v.x*=0.99;
			ship.v.y*=0.99;
			//update exhaust velocity
			forEach(ship.exhaust,function(b){
				b.v.x*=0.9;
				b.v.y*=0.9;
				//slight random variations
				b.v.x+=random(-0.3*b.v.x,0.3*b.v.x);
				b.v.y+=random(-0.3*b.v.y,0.3*b.v.y);
			});
			//check input, new exhaust and +velocity if exists
			if (io.keysHeld[87]){	//W
				ship.v.y-=1;
				ship.exhaust.push(new Exhaust(
					random(ship.x-20,ship.x+20),
					random(ship.y+15,ship.y+20),
					random(ship.v.x-1,ship.v.x+1),
					random(ship.v.y+speeds.exhaustMinVelocity,ship.v.y+speeds.exhaustMaxVelocity)),
				new Exhaust(
					random(ship.x-20,ship.x+20),
					random(ship.y+15,ship.y+20),
					random(ship.v.x-1,ship.v.x+1),
					random(ship.v.y+speeds.exhaustMinVelocity,ship.v.y+speeds.exhaustMaxVelocity)),
				new Exhaust(
					random(ship.x-20,ship.x+20),
					random(ship.y+15,ship.y+20),
					random(ship.v.x-1,ship.v.x+1),
					random(ship.v.y+speeds.exhaustMinVelocity,ship.v.y+speeds.exhaustMaxVelocity))
				);
			}
			if (io.keysHeld[65]){	//A
				ship.v.x-=1;
				ship.exhaust.push(new Exhaust(
					random(ship.x+15,ship.x+20),
					random(ship.y-20,ship.y+20),
					random(ship.v.x+speeds.exhaustMinVelocity,ship.v.x+speeds.exhaustMaxVelocity),
					random(ship.v.y-1,ship.v.y+1)),
				new Exhaust(
					random(ship.x+15,ship.x+20),
					random(ship.y-20,ship.y+20),
					random(ship.v.x+speeds.exhaustMinVelocity,ship.v.x+speeds.exhaustMaxVelocity),
					random(ship.v.y-1,ship.v.y+1)),
				new Exhaust(
					random(ship.x+15,ship.x+20),
					random(ship.y-20,ship.y+20),
					random(ship.v.x+speeds.exhaustMinVelocity,ship.v.x+speeds.exhaustMaxVelocity),
					random(ship.v.y-1,ship.v.y+1))
				);
			}
			if (io.keysHeld[83]){	//S
				ship.v.y+=1;
				ship.exhaust.push(new Exhaust(
					random(ship.x-20,ship.x+20),
					random(ship.y-20,ship.y-15),
					random(ship.v.x-1,ship.v.x+1),
					random(ship.v.y-speeds.exhaustMaxVelocity,ship.v.y-speeds.exhaustMinVelocity)),
				new Exhaust(
					random(ship.x-20,ship.x+20),
					random(ship.y-20,ship.y-15),
					random(ship.v.x-1,ship.v.x+1),
					random(ship.v.y-speeds.exhaustMaxVelocity,ship.v.y-speeds.exhaustMinVelocity)),
				new Exhaust(
					random(ship.x-20,ship.x+20),
					random(ship.y-20,ship.y-15),
					random(ship.v.x-1,ship.v.x+1),
					random(ship.v.y-speeds.exhaustMaxVelocity,ship.v.y-speeds.exhaustMinVelocity))
				);
			}
			if (io.keysHeld[68]){	//D
				ship.v.x+=1;
				ship.exhaust.push(new Exhaust(
					random(ship.x-20,ship.x-15),
					random(ship.y-20,ship.y+20),
					random(ship.v.x-speeds.exhaustMaxVelocity,ship.v.x-speeds.exhaustMinVelocity),
					random(ship.v.y-1,ship.v.y+1)),
				new Exhaust(
					random(ship.x-20,ship.x-15),
					random(ship.y-20,ship.y+20),
					random(ship.v.x-speeds.exhaustMaxVelocity,ship.v.x-speeds.exhaustMinVelocity),
					random(ship.v.y-1,ship.v.y+1)),
				new Exhaust(
					random(ship.x-20,ship.x-15),
					random(ship.y-20,ship.y+20),
					random(ship.v.x-speeds.exhaustMaxVelocity,ship.v.x-speeds.exhaustMinVelocity),
					random(ship.v.y-1,ship.v.y+1))
				);
			}
			//draw
			clear();
			forEach(ship.exhaust,function(b){
				b.draw();
			});
			ship.draw();
			//decrease visibility and remove black exhaust
			forEach(ship.exhaust,function(b){
				//if(b.color>50)
				b.color-=1;
				if(b.color<1)ship.exhaust.splice(ship.exhaust.indexOf(b),1);
			});

			setTimeout(loop,31);
		}



		window.onkeydown=io.keyDown;
		window.onkeyup=io.keyUp;
		window.onload=function(){
			canvas=document.getElementsByTagName('canvas')[0];
			canvas.width=window.innerWidth;
			canvas.height=window.innerHeight;
			context=canvas.getContext('2d');

			ship=new Ship(window.innerWidth/2,window.innerHeight/2);
			loop();
		};
		window.resize=function(){
			canvas.width=window.innerWidth;
			canvas.height=window.innerHeight;
		};
	</script>
</head>
<body>
	<canvas></canvas>
</body>
</html>
